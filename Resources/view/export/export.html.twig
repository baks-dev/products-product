<?xml version="1.0"?>

<yml_catalog date='{{ 'now'|date('Y-m-d\\TH:00:00P') }}'>
    <shop>
        <name>{{ settings.title is defined ? settings.title : 'Company name' }}</name>
        <company>{{ settings.description is defined ? settings.description : 'Добро пожаловать' }}</company>
        <url>{{ absolute_url(path('core:public.homepage')) }}</url>
        <platform>Symfony</platform>

        <categories>
            {% for id, cat in category %}
                <category id='{{ id }}'>{{ cat.category_name }}</category>
            {% endfor %}
        </categories>

        {# <delivery-options>
            <option cost="200" days="1"/>
        </delivery-options> #}

        {# <pickup-options>
            <option cost="200" days="1"/>
        </pickup-options> #}


        {# @var card \BaksDev\Products\Product\Repository\AllProductsByCategory\AllProductsByCategoryResult #}

        <offers>
            {% for card in products|filter(v => v.productPrice.roundValue > 0) %}

                {% set arr_property = card.categorySectionField %}

                <offer id='{{ card.productInvariable }}' available='{{ card.productQuantity > 0 ? 'true' : 'false' }}'>

                    <name>{{ card.productName }}
                        {# Значение множественного варианта ТП #}
                        {{ card.variationValue|call_twig_func(card.variationReference~'_render') ~ card.modificationValue|call_twig_func(card.modificationReference~'_render') }}
                        {# Значение торгового предложения #}
                        {{ card.offerValue|call_twig_func(card.offerReference~'_render') }}
                        {# Постфикс торгового предложения #}
                        {{ card.offerPostfix }}
                        {# Постфикс множественного варианта #}
                        {{ card.variationPostfix }}
                        {# Постфикс модификации #}
                        {{ card.modificationPostfix }}
                    </name>

                    {# Бренд #}
                    <vendor>{{ card.categoryName }}</vendor>
                    <vendorCode>{{ card.productArticle }}</vendorCode>

                    <url>{{ absolute_url(path('products-product:public.detail', {
                            category: card.categoryUrl,
                            url: card.productUrl,
                            offer: card.offerValue ?: null,
                            variation: card.variationValue ?: null,
                            modification: card.modificationValue ?: null,
                            postfix:  (card.modificationPostfix ?: card.variationPostfix ?: card.offerPostfix ?: null )|replace({ '/': '-' })
                        } )) }}</url>

                    <price>{{ card.productPrice.roundValue ?: 'по запросу' }}</price>
                    <currencyId>{{ card.productCurrency|upper }}</currencyId>

                    {% if card.productOldPrice %}
                        <oldprice>{{ card.productOldPrice }}</oldprice>
                    {% endif %}

                    {# <enable_auto_discounts>true</enable_auto_discounts> #}

                    <categoryId>{{ card.categoryId }}</categoryId>

                    {# Обложка  #}
                    {% set image_path = cdn_image_path(card.productImage, card.productImageExt, card.productImageCdn, 'large') %}

                    <picture>{{ absolute_url(image_path) }}</picture>

                    {% if card.modelName %}
                        <param name="Модель">{{ card.modelName }}</param>
                    {% endif %}

                    {% if card.offerName %}
                        <param name="{{ card.offerName }}">{{ card.offerValue }}</param>
                    {% endif %}

                    {% if card.variationName %}
                        <param name="{{ card.variationName }}">{{ card.variationValue }}</param>
                    {% endif %}

                    {% if card.modificationName %}
                        <param name="{{ card.modificationName }}">{{ card.modificationValue }}</param>
                    {% endif %}

                    {% if card.offerNamePostfix %}
                        <param name="{{ card.offerNamePostfix }}">{{ card.offerPostfix }}</param>
                    {% endif %}

                    {% if card.variationNamePostfix %}
                        <param name="{{ card.variationNamePostfix }}">{{ card.variationPostfix }}</param>
                    {% endif %}

                    {% if card.modificationNamePostfix %}
                        <param name="{{ card.modificationNamePostfix }}">{{ card.modificationPostfix }}</param>
                    {% endif %}


                    {# Свойства, учавствующие в ПРЕВЬЮ #}
                    {% if arr_property %}
                        {% for name_property in arr_property | filter(preview => preview.field_card == true) %}

                            {% set var = name_property.field_value|call_twig_func(name_property.field_type) %}
                            {% if var %}
                                <param name="{{ name_property.field_trans }}">{{ var }}</param>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if card.productQuantity > card.getCategoryThreshold %}
                        {% set stock = 'более '~card.getCategoryThreshold %}
                    {% elseif card.productQuantity > 0 %}
                        {% set stock = card.productQuantity %}
                    {% else %}
                        {% set stock = 'нет в наличии' %}
                    {% endif %}

                    <stock>{{ stock }}</stock>

                    <description>
                        <![CDATA[
                        {{ card.preview|raw }}
                        ]]>
                    </description>

                    {# <sales_notes>Необходима предоплата.</sales_notes> #}
                    {# <manufacturer_warranty>true</manufacturer_warranty> #}
                    {# <barcode>4601546021298</barcode> #}
                    {# <param name='Цвет'>белый</param> #}

                    {% if card.productBarcode %}
                        <barcode>{{ card.productBarcode }}</barcode>
                    {% endif %}

                    {% if card.productWeight is not empty %}

                        {# Вес товара с упаковкой в килограммах #}
                        <weight>{{ card.productWeight }}</weight>

                        {# Длина, ширина, высота в упаковке в сантиметрах. (20.1/20.551/22.5) #}
                        <dimensions>{{ card.productLength }}/{{ card.productWidth }}
                            /{{ card.productHeight }}</dimensions>

                    {% endif %}

                    {# <condition type='preowned'>
                    <quality>excellent</quality>
                </condition> #}
                </offer>

            {% endfor %}


        </offers>

    </shop>
</yml_catalog>